<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script async type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
</script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js" integrity="sha512-hpZ5pDCF2bRCweL5WoA0/N1elet1KYL5mx3LP555Eg/0ZguaHawxNvEjF6O3rufAChs16HVNhEc6blF/rZoowQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js" integrity="sha512-sv0slik/5O0JIPdLBCR2A3XDg/1U3WuDEheZfI/DI5n8Yqc3h5kjrnr46FGBNiUAJF7rE4LHKwQ/SoSLRKAxEA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

{%include "components/calloutScript.njk"%}

<script async src="https://fastly.jsdelivr.net/npm/force-graph@1.43.0/dist/force-graph.min.js"></script>

<script async src="https://fastly.jsdelivr.net/npm/@alpinejs/persist@3.11.1/dist/cdn.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/alpinejs@3.11.1/dist/cdn.min.js" async></script>

<style>
/* Modern Language Switcher â€“ Clean URLs Edition (2025) */
.language-switcher {
  position: fixed;
  top: 16px;
  right: 24px;
  z-index: 10000;
  display: flex;
  gap: 8px;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(20px);
  padding: 8px 16px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.2);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.language-switcher button {
  padding: 6px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  position: relative;
  overflow: hidden;
}

.language-switcher button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 102, 255, 0.3);
}

.language-switcher button.active {
  background: linear-gradient(135deg, #0066ff, #1e40af);
  color: white;
  box-shadow: 0 0 0 0 rgba(0, 102, 255, 0.4);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(0, 102, 255, 0.4); }
  70% { box-shadow: 0 0 0 10px rgba(0, 102, 255, 0); }
  100% { box-shadow: 0 0 0 0 rgba(0, 102, 255, 0); }
}

.language-switcher button:not(.active) {
  background: transparent;
  color: #374151;
}

.language-switcher button:not(.active):hover {
  background: #f3f4f6;
  color: #111827;
}

/* Dark mode */
@media (prefers-color-scheme: dark) {
  .language-switcher {
    background: rgba(17, 24, 39, 0.9);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(0, 0, 0, 0.2);
  }
  .language-switcher button:not(.active) {
    color: #d1d5db;
  }
  .language-switcher button:not(.active):hover {
    background: #374151;
    color: #f9fafb;
  }
}

/* Translation banner */
.translation-banner {
  position: fixed;
  top: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: #fef3c7;
  color: #92400e;
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 9999;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}
</style>

<script>
// Fixed Script: Clean URLs (/slug), Slugified Filenames (.en.md â†’ -en), Proper Redirects (2025)
document.addEventListener("DOMContentLoaded", async () => {
  const supportedLangs = { en: "EN", uz: "UZ" }; // Add more as needed
  const defaultLang = "en";
  const currentPath = window.location.pathname; // e.g., "/education/obsidian-tutorial/overview-en"
  const pathParts = currentPath.split("/").filter(Boolean);
  const currentSlug = pathParts.pop(); // e.g., "overview-en"
  const basePath = pathParts.length ? "/" + pathParts.join("/") : ""; // e.g., "/education/obsidian-tutorial"

  // Get lang from URL: ?lang=uz
  const params = new URLSearchParams(window.location.search);
  let currentLang = params.get("lang") || defaultLang;

  // 1. Create modern switcher
  const switcher = document.createElement("div");
  switcher.className = "language-switcher";
  Object.entries(supportedLangs).forEach(([code, label]) => {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.className = code === currentLang ? "active" : "";
    btn.onclick = () => switchToLang(code);
    switcher.appendChild(btn);
  });
  document.body.appendChild(switcher);

  // 2. Switch language with clean redirect
  async function switchToLang(lang) {
    if (lang === defaultLang) {
      // Clean English URL: strip any -uz suffix if present
      const cleanSlug = currentSlug.replace(`-${lang}`, `-en`) || `overview-en`; // Adjust base if needed
      window.location.href = basePath + "/" + cleanSlug;
      return;
    }

    // For Uzbek: Build target slug (e.g., "overview-uz") and check existence
    const targetSlug = currentSlug.replace(`-${defaultLang}`, `-${lang}`) || `${currentSlug.replace('-en', '')}-${lang}`;
    const targetPath = basePath + "/" + targetSlug; // e.g., "/education/obsidian-tutorial/overview-uz"
    
    try {
      const response = await fetch(targetPath, { method: "HEAD" });
      if (response.ok) {
        // Redirect to clean Uzbek URL (no ?lang)
        window.location.href = targetPath;
      } else {
        showTranslationBanner();
      }
    } catch (error) {
      console.error("Language check failed:", error);
      showTranslationBanner();
    }
  }

  // 3. On load: Auto-redirect if ?lang=uz and target exists
  if (currentLang !== defaultLang) {
    const targetSlug = currentSlug.replace(`-${defaultLang}`, `-${currentLang}`) || `${currentSlug.replace('-en', '')}-${currentLang}`;
    const targetPath = basePath + "/" + targetSlug;
    
    try {
      const response = await fetch(targetPath, { method: "HEAD" });
      if (response.ok) {
        window.location.href = targetPath; // Clean redirect
      } else {
        // Clean param, stay on English
        window.location.href = basePath + "/" + currentSlug;
      }
    } catch (error) {
      console.error("Auto-redirect failed:", error);
      window.location.href = basePath + "/" + currentSlug;
    }
  }

  // 4. Show fallback banner
  function showTranslationBanner() {
    if (document.querySelector(".translation-banner")) return;
    const banner = document.createElement("div");
    banner.className = "translation-banner";
    banner.innerHTML = `ðŸ¤” Tarjima tez orada tayyor bo'ladi! (Translation coming soon!)`;
    document.body.appendChild(banner);
    setTimeout(() => banner.remove(), 5000);
  }

  // 5. Uzbek UI tweaks: Swap sidebar titles via dg-metatitle (if present)
  if (currentLang === "uz") {
    document.title = document.querySelector('meta[property="og:title"]')?.content || document.title;
    // Sidebar swap (targets common Digital Garden classes)
    document.querySelectorAll(".tree-item a, .nav-link, .sidebar a").forEach(link => {
      const uzTitle = link.getAttribute("data-title-uz") || link.textContent.replace(/Overview/i, "Umumiy ko'rinish"); // Fallback replace
      if (uzTitle !== link.textContent) link.textContent = uzTitle;
    });
  }
});
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-okaidia.min.css" integrity="sha512-mIs9kKbaw6JZFfSuo+MovjU+Ntggfoj8RwAmJbVXQ5mkAX5LlgETQEweFPI18humSPHymTb5iikEOKWF7I8ncQ==" crossorigin="anonymous" referrerpolicy="no-referrer" async/>
<script src="https://fastly.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer" async></script>

<link href="/styles/digital-garden-base.css" rel="stylesheet">
{%-if meta.themeStyle%}
    <link href="/styles/obsidian-base.css" rel="stylesheet">
    <link href="{{meta.themeStyle}}" rel="stylesheet">
{% else %}
    <link href="/styles/style.css" rel="stylesheet">
{%endif%}

<link href="/styles/custom-style.css" rel="stylesheet">
{%- for style in dynamics.styles -%}
<link href="{{style}}" rel="stylesheet">
{%- endfor -%}

{% favicons './src/site/favicon.svg', appleIconBgColor='#123' %}

{% if metatags %}
    {% for name, content in metatags %}
        <meta name="{{ name }}" content="{{ content }}">
    {% endfor %}
{% endif %}

{% if meta.styleSettingsCss %}
    <style>
        {{ meta.styleSettingsCss | safe }}
    </style>
{% endif %}
<style>
</style>
